#!/usr/bin/env node
var debug = require('debug')('Rotas-Turisticas');
var app = require('../app');

var request = require('request');
var async = require("async");
var cheerio = require('cheerio');

app.set('port', process.env.PORT || 3000);

var server = app.listen(app.get('port'), function() {
  debug('Express server listening on port ' + server.address().port);
});

require("mongoose").connect("mongodb://andrepcg:dhji483hf849823bvngf@ds041380.mongolab.com:41380/rotas");
var PontoTuristico = require("../models/PontoTuristico");

var gmaputil = require('googlemapsutil');



var geocode = function(rua){
    gmaputil.geocoding(rua, null, function(err, result) {
        if (err)
            console.log(err);
        else {
            var json = JSON.parse(result);
            if(json.results[0].geometry.location)
                return json.results[0].geometry.location;

        }
    });
}

var f = function(ponto){
    ponto.gps = geocode(ponto.morada);
    ponto.save(function(err){
        if(err) console.error(err);
    });
}

PontoTuristico.find().exec(function(err, pontos){
    if(err)
        console.log(err);

    if(pontos){
        (function theLoop (i) {
            setTimeout(function () {
                f(pontos[i--]);
                f(pontos[i--]);
                f(pontos[i--]);
                f(pontos[i--]);
                f(pontos[i--]);

                if (--i) {
                    theLoop(i);
                }
            }, 5500);
        })(pontos.length);

    }

});

